var gadgets=gadgets||{};gadgets.util=function(){function a(){var a,b=document.location.href,c=b.indexOf("?"),d=b.indexOf("#");return a=-1===d?b.substr(c+1):[b.substr(c+1,d-c-1),"&",b.substr(d+1)].join(""),a.split("&")}function b(a,b){return String.fromCharCode(b)}function c(a){e=a["core.util"]||{}}var d=null,e={},f=[],g={0:!1,10:!0,13:!0,34:!0,39:!0,60:!0,62:!0,92:!0,8232:!0,8233:!0};return gadgets.config&&gadgets.config.register("core.util",null,c),{getUrlParameters:function(){if(null!==d)return d;d={};for(var b=a(),c=window.decodeURIComponent?decodeURIComponent:unescape,e=0,f=b.length;f>e;++e){var g=b[e].indexOf("=");if(-1!==g){var h=b[e].substring(0,g),i=b[e].substring(g+1);i=i.replace(/\+/g," "),d[h]=c(i)}}return d},makeClosure:function(a,b){for(var c=[],d=2,e=arguments.length;e>d;++d)c.push(arguments[d]);return function(){for(var d=c.slice(),e=0,f=arguments.length;f>e;++e)d.push(arguments[e]);return b.apply(a,d)}},makeEnum:function(a){for(var b,c={},d=0;b=a[d];++d)c[b]=b;return c},getFeatureParameters:function(a){return"undefined"==typeof e[a]?null:e[a]},hasFeature:function(a){return"undefined"!=typeof e[a]},registerOnLoadHandler:function(a){f.push(a)},runOnLoadHandlers:function(){for(var a=0,b=f.length;b>a;++a)f[a]()},escape:function(a,b){if(!a)return a;if("string"==typeof a)return gadgets.util.escapeString(a);if("array"==typeof a)for(var c=0,d=a.length;d>c;++c)a[c]=gadgets.util.escape(a[c]);else if("object"==typeof a&&b){var e={};for(var f in a)a.hasOwnProperty(f)&&(e[gadgets.util.escapeString(f)]=gadgets.util.escape(a[f],!0));return e}return a},escapeString:function(a){for(var b,c,d=[],e=0,f=a.length;f>e;++e)b=a.charCodeAt(e),c=g[b],c===!0?d.push("&#",b,";"):c!==!1&&d.push(a.charAt(e));return d.join("")},unescapeString:function(a){return a.replace(/&#([0-9]+);/g,b)}}}(),gadgets.util.getUrlParameters();var gadgets=gadgets||{};gadgets.json=function(){function f(a){return 10>a?"0"+a:a}function stringify(a){var b,c,d,e,f,g=/["\\\x00-\x1f\x7f-\x9f]/g;switch(typeof a){case"string":return g.test(a)?'"'+a.replace(g,function(a){var b=m[a];return b?b:(b=a.charCodeAt(),"\\u00"+Math.floor(b/16).toString(16)+(b%16).toString(16))})+'"':'"'+a+'"';case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";if(b=[],"number"==typeof a.length&&!a.propertyIsEnumerable("length")){for(e=a.length,c=0;e>c;c+=1)b.push(stringify(a[c])||"null");return"["+b.join(",")+"]"}for(d in a)a.hasOwnProperty(d)&&"string"==typeof d&&(f=stringify(a[d]),f&&b.push(stringify(d)+":"+f));return"{"+b.join(",")+"}"}}Date.prototype.toJSON=function(){return[this.getUTCFullYear(),"-",f(this.getUTCMonth()+1),"-",f(this.getUTCDate()),"T",f(this.getUTCHours()),":",f(this.getUTCMinutes()),":",f(this.getUTCSeconds()),"Z"].join("")};var m={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:stringify,parse:function(text){return/^[\],:{}\s]*$/.test(text.replace(/\\["\\\/b-u]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))?eval("("+text+")"):!1}}}();var gadgets=gadgets||{};gadgets.rpc=function(){function a(){return"function"==typeof window.postMessage?"wpm":"object"==typeof window.postMessage?"wpm":"function"==typeof document.postMessage?"dpm":window.ActiveXObject?"nix":"Gecko"===navigator.product?"fe":"ifpc"}function b(){if("dpm"===L||"wpm"===L){var a=function(a){f(gadgets.json.parse(a.data))};"undefined"!=typeof window.addEventListener?window.addEventListener("message",a,!1):"undefined"!=typeof window.attachEvent&&window.attachEvent("onmessage",a)}if("nix"===L&&"unknown"!=typeof window[u]){window[v]=function(a){f(gadgets.json.parse(a))},window[w]=function(a,b,c){C[a]==c&&(x[a]=b)};var b="Class "+t+"\n Private m_Intended\nPrivate m_Auth\nPublic Sub SetIntendedName(name)\n If isEmpty(m_Intended) Then\nm_Intended = name\nEnd If\nEnd Sub\nPublic Sub SetAuth(auth)\n If isEmpty(m_Auth) Then\nm_Auth = auth\nEnd If\nEnd Sub\nPublic Sub SendMessage(data)\n "+v+"(data)\nEnd Sub\nPublic Function GetAuthToken()\n GetAuthToken = m_Auth\nEnd Function\nPublic Sub CreateChannel(channel, auth)\n Call "+w+"(m_Intended, channel, auth)\nEnd Sub\nEnd Class\nFunction "+u+"(name, auth)\nDim wrap\nSet wrap = New "+t+"\nwrap.SetIntendedName name\nwrap.SetAuth auth\nSet "+u+" = wrap\nEnd Function";try{window.execScript(b,"vbscript")}catch(c){L="ifpc"}}}function c(a){if("{"!=a.charAt(0))return a;{var b=gadgets.json.parse(a);b.id}return gadgets.json.stringify({id:b.id})}function d(a,b){if(!F[a]){if("fe"===L)try{var c=document.getElementById(a);c[r]=function(a){f(gadgets.json.parse(a))}}catch(d){}if("nix"===L)try{var c=document.getElementById(a),e=window[u](a,b);c.contentWindow.opener=e}catch(d){}F[a]=!0}}function e(a){for(var b=gadgets.json.stringify,c=[],d=0,e=a.length;e>d;++d)c.push(encodeURIComponent(b(a[d])));return c.join("&")}function f(a){if(a&&"string"==typeof a.s&&"string"==typeof a.f&&a.a instanceof Array){if(a.f=c(a.f),C[a.f]&&C[a.f]!=a.t)throw new Error("Invalid auth token.");a.c&&(a.callback=function(b){gadgets.rpc.call(a.f,p,null,a.c,b)});var b=(y[a.s]||y[q]).apply(a,a.a);a.c&&"undefined"!=typeof b&&gadgets.rpc.call(a.f,p,null,a.c,b)}}function g(a,b,c,d){try{if(".."!=c){var e=x[".."];if(!e&&window.opener&&"GetAuthToken"in window.opener&&(e=window.opener,e.GetAuthToken()==C[".."])){var f=C[".."];e.CreateChannel(window[u]("..",f),f),x[".."]=e,window.opener=null}if(e)return void e.SendMessage(d)}else if(x[a])return void x[a].SendMessage(d)}catch(g){}i(a,b,c,d)}function h(a,b,c,d,e){try{if(".."!=c){var g=window.frameElement;if("function"==typeof g[r])return"function"!=typeof g[r][s]&&(g[r][s]=function(a){f(gadgets.json.parse(a))}),void g[r](d)}else{var h=document.getElementById(a);if("function"==typeof h[r]&&"function"==typeof h[r][s])return void h[r][s](d)}}catch(j){}i(a,b,c,d,e)}function i(a,b,c,d,f){var g=gadgets.rpc.getRelayUrl(a);if(!g)throw new Error("No relay file assigned for IFPC");var h=null,i=[];if(B[a])h=[g,"#",e([c,D,1,0,e([c,b,"","",c].concat(f))])].join(""),i.push(h);else if(h=[g,"#",encodeURIComponent(a),"&",c,"@",D,"&"].join(""),K[a])for(var j,k=encodeURIComponent(d),m=I-h.length,n=Math.ceil(k.length/m),o=0;k.length>0;)j=k.substring(0,m),k=k.substring(m),i.push([h,n,"&",o,"&",j].join("")),o+=1;else i.push([h,1,"&",0,"&",,encodeURIComponent(d)].join(""));do l(i.shift(),a);while(i.length>0);return!0}function j(a){if(!a)return!1;if(".."==a)return!1;var b=document.getElementById(a);return b?!1:"undefined"==typeof _childWindows?!1:!0}function k(a,b){for(var c=b-1;c>=0;--c)if("undefined"==typeof a[c])return!1;return!0}function l(a,b){if(j(b)){var c=window._childWindowMessageId;return c++,window._childWindowMessageQueue.push({id:c,target:b,src:a}),window._childWindowMessageId++,void(window._childWindowMessageQueue.length>20&&window._childWindowMessageQueue.shift())}for(var d,e=z.length-1;e>=0;--e){var f=z[e];try{if(f&&(f.recyclable||"complete"===f.readyState)){if(f.parentNode.removeChild(f),!window.ActiveXObject){f.recyclable=!1,d=f;break}z[e]=f=null,z.splice(e,1)}}catch(g){}}d||(d=document.createElement("iframe"),d.style.border=d.style.width=d.style.height="0px",d.style.visibility="hidden",d.style.position="absolute",d.onload=function(){this.recyclable=!0},z.push(d)),d.src=a,setTimeout(function(){document.body.appendChild(d)},0)}function m(a){if("undefined"==typeof a||".."===a){try{if(G[a]!==!1&&window.parent.opener)return window.parent.opener.parent}catch(b){}return window.parent}a=String(a);var c=null;if(c=document.getElementById(a),c&&c.contentWindow)return c.contentWindow;if("undefined"!=typeof _childWindows)for(var d=0;d<_childWindows.length;d++){var e=_childWindows[d];try{e.document&&(c=e.document.getElementById(a))}catch(b){}if(c&&c.contentWindow)return c.contentWindow}return null}function n(a,b){var c;if(G[a]!==!1){var d=m(a);try{c=d.gadgets.rpc.receiveSameDomain}catch(e){}}return"function"==typeof c?(c(b),G[a]=!0,!0):(G[a]=!1,!1)}function o(a){if("http://"===a.rpc.parentRelayUrl.substring(0,7))A[".."]=a.rpc.parentRelayUrl;else{for(var b,c=document.location.search.substring(0).split("&"),d="",e=0;b=c[e];++e)if(0===b.indexOf("parent=")){d=decodeURIComponent(b.substring(7));break}A[".."]=d+a.rpc.parentRelayUrl}B[".."]=!!a.rpc.useLegacyProtocol}var p="__cb",q="",r="__g2c_rpc",s="__c2g_rpc",t="GRPC____NIXVBS_wrapper",u="GRPC____NIXVBS_get_wrapper",v="GRPC____NIXVBS_handle_message",w="GRPC____NIXVBS_create_channel",x={},y={},z=[],A={},B={},C={},D=0,E={},F={},G={},H={};gadgets.util&&(H=gadgets.util.getUrlParameters()),C[".."]=H.rpctoken||H.ifpctok||0;var I=2e3,J={},K={},L=a();if(b(),y[q]=function(){},y[p]=function(a,b){var c=E[a];c&&(delete E[a],c(b))},window._childWindowMessageQueue=[],window._childWindowMessageId=0,window._getChildWindowMessage=function(a){for(var b=_childWindowMessageQueue,c=0;c<b.length;c++){var d=b[c];if(d.id==a)return d}},gadgets.config){var M={parentRelayUrl:gadgets.config.NonEmptyStringValidator};gadgets.config.register("rpc",M,o)}return{register:function(a,b){if(a==p)throw new Error("Cannot overwrite callback service");if(a==q)throw new Error("Cannot overwrite default service: use registerDefault");y[a]=b},unregister:function(a){if(a==p)throw new Error("Cannot delete callback service");if(a==q)throw new Error("Cannot delete default service: use unregisterDefault");delete y[a]},registerDefault:function(a){y[""]=a},unregisterDefault:function(){delete y[""]},call:function(a,b,d){++D,a=c(a)||"..",d&&(E[D]=d);var e="..";".."===a&&(e=c(window.name));var f={s:b,f:e,c:d?D:0,a:Array.prototype.slice.call(arguments,3),t:C[a]};if(!n(a,f)){var j=gadgets.json.stringify(f),k=L;switch(B[a]&&(k="ifpc"),console.log("Sending to widget on "+k+" at url "+A[a]+" with "+typeof j+"=",j),k){case"dpm":var l=m(a),o=l.document;if(null!=o)try{o.postMessage(j)}catch(p){i(a,b,e,j,f.a)}break;case"wpm":var l=m(a);if(null!=l)try{l.postMessage(j,"*")}catch(p){i(a,b,e,j,f.a)}break;case"nix":g(a,b,e,j);break;case"fe":h(a,b,e,j,f.a);break;default:i(a,b,e,j,f.a)}}},getRelayUrl:function(a){return A[a]},setRelayUrl:function(a,b,c,d){A[a]=b,B[a]=!!c,K[a]=!!d},setAuthToken:function(a,b){C[a]=b,d(a,b)},getRelayChannel:function(){return L},receive:function(a){if(a.length>4){var b=a[1],c=parseInt(a[2],10),d=parseInt(a[3],10),e=a[a.length-1],g=1===c;c>1&&(J[b]||(J[b]=[]),J[b][d]=e,k(J[b],c)&&(e=J[b].join(""),delete J[b],g=!0)),g&&f(gadgets.json.parse(decodeURIComponent(e)))}},receiveSameDomain:function(a){a.a=Array.prototype.slice.call(a.a),window.setTimeout(function(){f(a)},0)}}}(),ozpIwc.Owf7Participant=function(a){if(a=a||{},!a.listener)throw"Needs to have an OWF7ParticipantListener";if(!a.client)throw"Needs an IWC Client";if(!a.guid)throw"Must be assigned a guid for this widget";if(!a.url)throw"Needs a url for the widget";if(!a.iframe)throw"Needs an iframe";if(!a.rpcId)throw"Needs an rpcID";if(!a.instanceId)throw"Needs an widget instance id";this.client=a.client,this.listener=a.listener,this.rpcId=a.rpcId,this.instanceId=a.instanceId,this.widgetQuery="?lang=en_US&owf=true&themeName=a_default&themeContrast=standard&themeFontSize=12",this.iframe=a.iframe,this.widgetParams={id:this.instanceId,webContextPath:"/owf",preferenceLocation:this.listener.prefsUrl,relayUrl:this.listener.rpcRelay,url:a.url,guid:a.guid,layout:"desktop",containerVersion:"7.0.1-GA",owf:!0,lang:"en_US",currentTheme:{themeName:"a_default",themeContrast:"standard",themeFontSize:12},version:1,locked:!1,data:a.launchData}},ozpIwc.Owf7Participant.prototype.initializeIframe=function(){this.iframe.setAttribute("name",JSON.stringify(this.widgetParams)),this.iframe.setAttribute("src",this.widgetParams.url+this.widgetQuery),this.iframe.setAttribute("id",this.rpcId)},ozpIwc.Owf7Participant.prototype.onContainerInit=function(a,b){console.log("Connecting from a new recipient: "+a+" with message: ",b),("undefined"===window.name||""===window.name)&&(window.name="ContainerWindowName"+Math.random());var c=gadgets.json.parse(b),d=c.useMultiPartMessagesForIFPC,e=this.rpcId;gadgets.rpc.setRelayUrl(e,c.relayUrl,!1,d),gadgets.rpc.setAuthToken(e,0);var f='{"id":"'+window.name+'"}';gadgets.rpc.call(e,"after_container_init",null,window.name,f),console.log("Registered ",e," with relayUrl ",c.relayUrl)},ozpIwc.Owf7Participant.prototype.onPublish=function(a,b,c){this.client.send({dst:"data.api",resource:"/owf-legacy/eventing/"+b,action:"set",entity:c})},ozpIwc.Owf7Participant.prototype.onSubscribe=function(a,b){var c=this;this.subscriptions[b]=!0,this.client.send({dst:"data.api",resource:"/owf-legacy/eventing/"+b,action:"watch"},function(a,d){this.subscriptions[b]?(console.log("Got subscription for "+c.rpcId+" on "+b,a.entity.newValue),gadgets.rpc.call(c.rpcId,"pubsub",null,b,null,JSON.stringify(a.entity.newValue))):d()})},ozpIwc.Owf7Participant.prototype.onUnsubscribe=function(a,b){this.subscriptions[b]=!1},function(){var a=function(a){var b=document.createElement("a");return b.href=a,b.protocol+"//"+b.host+b.pathname+b.search+b.hash};ozpIwc.Owf7ParticipantListener=function(b){this.rpcRelay=a(b.rpcRelay||"rpc_relay.uncompressed.html"),this.prefsUrl=a(b.prefsUrl||"owf7prefs.html"),this.participants={};var c=function(a){return"[service:"+a.s+",from:"+a.f+"]:"+JSON.stringify(a.a)};console.log("Registering RPC hooks"),gadgets.rpc.registerDefault(function(){console.log("Unknown rpc "+c(this))});var d=this;gadgets.rpc.register("container_init",function(a,b){console.log("Connecting from a new recipient: "+a+" with message: ",b),("undefined"===window.name||""===window.name)&&(window.name="ContainerWindowName"+Math.random());var c=gadgets.json.parse(b),e=c.useMultiPartMessagesForIFPC,f=d.rpcId;gadgets.rpc.setRelayUrl(f,c.relayUrl,!1,e),gadgets.rpc.setAuthToken(f,0);var g='{"id":"'+window.name+'"}';gadgets.rpc.call(f,"after_container_init",null,window.name,g),console.log("Registered ",f," with relayUrl ",c.relayUrl)}),gadgets.rpc.register("_widget_iframe_ready",function(){}),gadgets.rpc.register("_WIDGET_STATE_CHANNEL_"+this.widgetParams.id,function(){}),gadgets.rpc.register("pubsub",function(a,b,c,d){var e=this.participants[0];if(!e)throw"Unknown participant";switch(a){case"publish":e.onPublish(a,b,c,d);break;case"subscribe":e.onPublish(a,b,c,d);break;case"unsubscribe":}}),gadgets.rpc.register("_WIDGET_LAUNCHER_CHANNEL",function(){iframe.name})},ozpIwc.Owf7ParticipantListener.prototype.addWidget=function(a){a.listener=this,a.client=new ozpIwc.InternalParticipant,ozpIwc.defaultRouter.registerParticipant(a.client),a.guid="eb5435cf-4021-4f2a-ba69-dde451d12551",a.instanceId="666f46bf-d8da-27c4-b907-f4a3a9e58c75",a.rpcId=gadgets.json.stringify({id:instanceId}),this.participants[a.rpcId]=new ozpIwc.Owf7Participant(a)}}();var params=ozpIwc.util.parseQueryParams(),adapter=new ozpIwc.Owf7ParticipantListener({url:params.url,iframe:document.getElementById("widgetFrame")});
//# sourceMappingURL=ozp-iwc-owf7-widget-adapter.min.js.map